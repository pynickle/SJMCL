# SJMCL Copilot Instructions

*This instructions is generated by Copilot agent itself*

## Repository Overview

SJMCL is a cross-platform Minecraft launcher built with **Tauri v2** architecture. It combines a **Rust backend** with a **Next.js frontend** to provide a native desktop application that supports Windows, macOS, and Linux.

### Project Summary
- **Purpose**: Cross-platform Minecraft launcher with instance management, resource management, and multi-account support
- **Architecture**: Tauri v2 (Rust backend + Next.js frontend)
- **Repository Size**: ~4.5k files (excluding node_modules)
- **Languages**: Rust (backend), TypeScript/JavaScript (frontend), Python (scripts)
- **Frameworks**: Tauri v2, Next.js, React, Chakra UI
- **Target Platforms**: Windows 10+, macOS 10.15+, Linux (webkit2gtk 4.1+)
- **Supported Architectures**: x86_64, i686 (Windows), aarch64, x86_64 (macOS), x86_64 (Linux)

## Build and Development Requirements

### Prerequisites
- **Node.js**: Version 22 or higher (required by Tauri v2)
- **Rust**: Latest stable version with Cargo
- **npm**: For frontend package management
- **Platform-specific dependencies**:
  - **Linux**: `libwebkit2gtk-4.1-dev`, `libappindicator3-dev`, `librsvg2-dev`, `patchelf`
  - **Windows**: No additional dependencies required
  - **macOS**: Xcode command line tools

### Environment Setup

**CRITICAL**: Always copy `.env.template` to `.env` before building:
```bash
cp .env.template .env
```

The `.env` file contains required environment variables that are embedded into the Rust backend at compile time:
- `SJMCL_CURSEFORGE_API_KEY`: CurseForge API key for mod downloads
- `NEXT_PUBLIC_DEV_TOOLBAR`: Development toolbar toggle

Without the `.env` file, the build will fail or produce a non-functional application.

## Build Commands

### Initial Setup
```bash
# Clone and install dependencies (required first step)
npm install

# Install system dependencies on Linux before building
# Ubuntu/Debian:
sudo apt-get update
sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf
```

**Build Times**: 
- Initial Rust compilation: 5-10 minutes
- Subsequent builds: 2-5 minutes
- Frontend build: 1-2 minutes

### Development
```bash
# Start development server (frontend + backend)
npm run tauri dev
```
This starts the Next.js dev server at `http://localhost:3000` and launches the Tauri application.

### Production Build
```bash
# Build for production
npx tauri build
```

## Linting and Code Quality

### Frontend Linting
```bash
# Lint TypeScript/JavaScript files
npx eslint 'src/**/*.{js,jsx,ts,tsx}' --no-fix --max-warnings=0
```

**Known Issue**: The project uses ESLint v8 config format (`.eslintrc.json`) but modern npm may install ESLint v9. Use `npx --package=eslint@8 eslint ...` if you encounter config errors. The lint-staged configuration depends on this working correctly.

### Rust Formatting
```bash
# Check Rust code formatting
find src-tauri/src -name '*.rs' | xargs rustfmt --check
```

Configuration: `src-tauri/rustfmt.toml` (max_width: 100, 2-space tabs)

### Pre-commit Hooks
The project uses Husky for pre-commit hooks:
```bash
# Runs automatically on commit
npm run lint-staged
```

This validates:
- Frontend code with ESLint (requires compatible ESLint version)
- Rust code with rustfmt
- Locale files consistency (requires `chalk` npm package to be available)

## Testing and Validation

### Manual Testing
```bash
# Test development build
npm run tauri dev

# Test production build
npx tauri build
```

### CI Pipeline Validation
The GitHub Actions pipeline validates:
1. **Lint Job**: ESLint (frontend) + rustfmt (backend)
2. **Build Job**: Multi-platform test builds (Ubuntu primarily in PR tests)
3. **Environment**: Requires secrets for CurseForge API

**Important**: CI uses specific package versions and may work differently than local builds.

To replicate CI locally:
```bash
# Frontend linting (matches CI)
npx --package=eslint@8 eslint 'src/**/*.{js,jsx,ts,tsx}' --no-fix --max-warnings=0

# Rust formatting (matches CI) 
find src-tauri/src -name '*.rs' | xargs rustfmt --check

# Test build (matches CI - requires env vars)
npx tauri build
```

## Project Architecture and Layout

### Directory Structure
```
├── src/                    # Next.js frontend source
│   ├── components/         # React components
│   ├── pages/             # Next.js pages
│   ├── contexts/          # React contexts
│   ├── hooks/             # Custom React hooks
│   ├── services/          # API service layers
│   ├── locales/           # Internationalization files
│   └── utils/             # Frontend utilities
├── src-tauri/             # Rust backend source
│   ├── src/               # Rust source code
│   │   ├── account/       # User account management
│   │   ├── discover/      # Discovery and exploration features
│   │   ├── instance/      # Game instance management
│   │   ├── launch/        # Game launching logic
│   │   ├── launcher_config/ # Application configuration
│   │   ├── resource/      # Resource downloading
│   │   ├── tasks/         # Background task management
│   │   └── utils/         # Backend utilities
│   ├── assets/            # Static assets (icons, game files, etc.)
│   ├── capabilities/      # Tauri capability definitions
│   ├── libs/              # Custom Rust libraries
│   ├── Cargo.toml         # Rust dependencies
│   ├── tauri.conf.json    # Tauri configuration
│   └── build.rs           # Build script (env var handling)
├── scripts/               # Build and maintenance scripts
│   ├── version/           # Version management
│   ├── locale/            # Localization tools
│   ├── release/           # Release preparation
│   └── game/              # Game version fetching
└── .github/workflows/     # CI/CD pipelines
```

### Key Configuration Files
- **Frontend**: `package.json`, `tsconfig.json`, `next.config.ts`, `.eslintrc.json`, `.prettierrc`
- **Backend**: `src-tauri/Cargo.toml`, `src-tauri/tauri.conf.json`, `src-tauri/rustfmt.toml`
- **Environment**: `.env.template` (copy to `.env`)
- **CI/CD**: `.github/workflows/test.yml`, `.github/workflows/build.yml`

### Major Architectural Components

#### Frontend (Next.js/React)
- **Framework**: Next.js with static export (`output: "export"` in next.config.ts)
- **UI Library**: Chakra UI v2 for component system
- **State Management**: React Context API
- **Internationalization**: Custom i18n with JSON files in `src/locales/`
- **Development**: Supports hot reload via Tauri dev server

#### Backend (Rust/Tauri)
- **Entry Point**: `src-tauri/src/main.rs` → `src-tauri/src/lib.rs`
- **Command Architecture**: Tauri commands exposed to frontend via `tauri::generate_handler![]`
- **Core Modules**:
  - `account`: Microsoft OAuth, 3rd-party auth, offline accounts
  - `discover`: Discovery and exploration features
  - `instance`: Game instance and mod management
  - `launch`: Game launching and process management
  - `resource`: CurseForge/Modrinth integration for downloading mods/modpacks/saves/shaderpacks/resourcepacks
  - `tasks`: Background task management and processing
  - `launcher_config`: Application settings and configuration
- **Build System**: Custom `build.rs` handles environment variable injection

#### Inter-Process Communication
- Frontend calls Rust via `@tauri-apps/api` npm package
- All API endpoints defined as Tauri commands in respective Rust modules
- State managed via Rust `Mutex<T>` for thread-safe access

## Validation and Deployment

### GitHub Actions Workflows
1. **test.yml**: Runs on PR/push to main - linting and test builds
2. **build.yml**: Reusable workflow for multi-platform builds
3. **release.yml**: Production release builds and GitHub releases
4. **nightly.yml**: Automated nightly builds

### Release Process
- Version management via `npm run version bump <version>`
- Updates `package.json`, `src-tauri/tauri.conf.json`, and `src-tauri/Cargo.toml`
- Automated changelog generation in `scripts/release/`

### Common Issues and Workarounds

1. **Environment Variables**: Always ensure `.env` exists and contains required values
2. **ESLint Version Conflicts**: Use `npx --package=eslint@8` if modern ESLint causes config issues
3. **Rust Compilation**: First build can take 5-10 minutes - this is normal
4. **Platform Dependencies**: 
   - Linux requires webkit2gtk and other system libraries (`sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf`)
   - Missing system libs cause `pkg-config` errors during Rust compilation
5. **Node.js Version**: Tauri v2 requires Node.js >=22, older versions will fail
6. **npm install issues**: If npm install fails or hangs, try `npm ci` instead
7. **Script dependencies**: Some maintenance scripts (like locale tools) may require all npm dependencies to be installed

## Commit Message and PR Title Conventions

The project follows a specific format for both commit messages and PR titles to ensure consistency:

**Format**: `category(domain): content`

This unified format applies to:
- **Commit messages**: All commits must follow this format
- **PR titles**: All pull request titles must follow this format

**Categories**:
- `feat`: New features
- `fix`: Bug fixes  
- `docs`: Documentation changes
- `style`: Code style changes
- `refactor`: Code refactoring
- `test`: Test additions/changes
- `chore`: Maintenance tasks
- `perf`: Performance improvements
- `ci`: CI/CD changes
- `build`: Build system changes

**Domains**:
- `frontend`: Frontend-only or primarily frontend changes
- `backend`: Backend-only or primarily backend changes  
- `launch`: Game launching functionality (often full-stack)
- `config`: Configuration management
- `ui`: User interface components
- `api`: API changes
- `deps`: Dependency updates

**Examples**:
- `feat(frontend): support instance searching` - Frontend feature for instance search
- `fix(launch): resolve game startup crash on Linux` - Launch system bug fix
- `docs(api): update authentication flow documentation` - API documentation update
- `chore(deps): update tauri to v2.1.0` - Dependency update

**Both commit messages and PR titles must use this format** to maintain consistency with the project's conventions.

## Developer Productivity Tips

1. **Use existing scripts**: `npm run version check/bump`, `npm run locale` for common tasks
2. **Test incrementally**: Use `cargo check` in `src-tauri/` for faster Rust validation without full compilation
3. **Leverage hot reload**: `npm run tauri dev` provides fast iteration for frontend changes
4. **Check CI locally**: Run the same linting commands as CI before committing
5. **Environment setup**: Always start with `cp .env.template .env && npm install`
6. **Dependency order**: Install system dependencies (Linux) before npm install to avoid build issues
7. **Troubleshoot builds**: Check `cargo check` output for Rust issues, `npx eslint` for frontend issues

### Quick Start Checklist
```bash
# 1. Setup environment
cp .env.template .env
npm install

# 2. Verify setup
cargo --version  # Should show Rust toolchain
node --version   # Should be 22+
npm run version check  # Should show matching versions

# 3. Test build components
cd src-tauri && cargo check  # Test Rust compilation
cd .. && npx eslint 'src/**/*.{js,jsx,ts,tsx}' --no-fix --max-warnings=0  # Test linting

# 4. Development
npm run tauri dev  # Start development server
```

---

**Trust these instructions** - they are based on thorough analysis of the codebase, build configurations, and CI pipelines. Only perform additional exploration if the information above is incomplete or found to be incorrect.